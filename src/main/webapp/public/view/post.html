<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0" charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="/public/stylesheet/post-page.css">
</head>
<body>
	<div class="fixed-action-btn">
		<a class="btn-floating btn-large red">
		<i class="large material-icons">mode_edit</i>
		</a>
		<ul>
			<li><a class="btn-floating red add-post"><i class="material-icons">note_add</i></a></li>
			<li><a class="btn-floating yellow darken-1 edit-post">
				<i class="material-icons">mode_edit</i></a>
			</li>
			<li><a class="btn-floating green delete-post"><i class="material-icons">not_interested</i></a></li>
		</ul>
	</div>
	
	<!-- Modal Structure -->
	<div id="post-modal row" class="modal z-depth-5 grey lighten-4">
		<div class="row modal-content">
			<div class="row valign center-align">
				<form id="post-form" class="row" name="postForm" method="post" enctype="multipart/form-data">
					<div class="row title-container">
						<div class="input-field col m8 offset-m2">
				          <input id="title" type="text" class="center-align" placeholder="제목">
				        </div>
					</div>
					<hr class="title-liner"/>
					<div class="row item-container">
						<!-- 사용자가 직접 엘리먼트를 추가한다. -->
						<input name="image" class="col s3" type="file" accept="image/*" onchange="getThumbnailPrivew(this)"/>
					</div>
				</form>
			</div>
		</div>
		<div class="row modal-footer ">
			<a class="col s3 center-align modal-action modal-close waves-effect waves-green btn-flat complete" onclick="uploadFile()">완료</a>
			<a class="col s3 center-align modal-action waves-effect waves-green btn-flat add-hr">구분선추가</a>
			<a class="col s3 center-align modal-action waves-effect waves-green btn-flat add-image">이미지추가</a>
			<input class="col s3" type="file" accept="image/*" onchange="getThumbnailPrivew(this)" hidden="true"/>
			<a class="col s3 center-align modal-action waves-effect waves-green btn-flat add-content">글추가</a>
		</div>
	</div>

	<script>
		$(document).ready(function() {
			$('#title').attr('name', 'title-'+new Date().getTime());
			
			$('.modal').modal({
				dismissible : true,
				opacity : .1,
				in_duration : 180,
				out_duration : 180,
				starting_top : '2%',
				ending_top : '2%',
				ready : function(modal, trigger) {
					content = 0;
					image = 0;
					line = 0;
					
					$(modal).css({
						'height' : $(window).height() - 30 +'px'
					});
					
					$('.modal-footer').css({
						'position' : 'fixed',
						'z-index' : '99999',
						'top' : $(modal).height() - $('.modal-footer').height()
					});
					
					$(modal).scroll(function(event) {
						$('.modal-footer').css('top', $(modal).height() - $('.modal-footer').height() + $(modal).scrollTop());
					});
					
					$('.add-content').click(function(){
						var $div = createDivision();
						var $textarea = document.createElement('textarea');
						$($textarea).attr({
							'name' : 'content-' + (new Date().getTime()),
							'placeholder' : '내용을 입력하세요.'
						});
						$($textarea).addClass("col s12 materialize-textarea validate center-align");
						$($div).append($textarea);
						addMouseHoverEventOnElement($div);
						$('.item-container').append($div);
					});
					
					$('.add-image').click(function(e){
						e.preventDefault();
						$('input:file').click();
					});
					
					$('.add-hr').click(function(){
						var $div = createDivision();
						var $hr = document.createElement('hr');
						var $hiddenInput = document.createElement('input');
						$($hiddenInput).attr({
							'type' : 'text',
							'name' : 'line-' + (new Date().getTime()),
							'hidden' : 'hidden'
						});
						
						$($hiddenInput).val('true');
						$($div).append($hiddenInput);
						$($div).append($hr);
						addMouseHoverEventOnElement($div);
						$('.item-container').append($div);
					});
				},
				complete : function() {
				}
			});
			
			$('.add-post').click(function(){
				$('.modal').modal('open');
			});
		});
		
		function createDivision(){
			var $div = document.createElement('div');
			$($div).addClass('row item-wrapper');
			$($div).css({
				'position' : 'relative',
				'margin-bottom' : '5px'
			});
			
			return $div;
		};
		
		function addMouseHoverEventOnElement(element){
			var menu = addAndGetMenuTab($(element));
			
			$(element).on('mouseenter', function(){
				$(menu).css('opacity', '1');
			});
			
			$(element).on('mouseleave', function(){
				$(menu).css('opacity', '0');
			});
		};
		
		function addAndGetMenuTab(toAttachElement){
			var $menu = document.createElement('button');
			$($menu).text('대충 만들어보는 메뉴탭');
			$($menu).addClass('z-depth-3');
			$($menu).css({
				'width' : '180px',
				'height' : '30px',
				'opacity' : '0',
				'position' : 'absolute',
				'top' : '-30px',
				'left' : $('.item-container').width() - 180,
				'z-index' : '9999'
			});
			
			$($menu).click(function(){
				$(toAttachElement).remove();
			});
			
			$(toAttachElement).append($menu);
			
			return $menu;
		};
		
		imageList = [];
		
		function getThumbnailPrivew(html){
			
			var $preview = createDivision();
			
			addMouseHoverEventOnElement($preview);
			
			if (html.files && html.files[0]) {
				imageList.push(html.files[0]);
				console.log(imageList);
				
		        var reader = new FileReader();
		        reader.onload = function (e) {
		            $($preview).css('display', '');
		            //$target.css('background-image', 'url(\"' + e.target.result + '\")'); // 배경으로 지정시
		            $($preview).append('<img class="col s10 offset-s1 m6 offset-m3 l6 offset-l3 image-preview" src="' + e.target.result + '" border="0" height="235" alt="" />');
		            $('.item-container').append($preview);
		        }
		        reader.readAsDataURL(html.files[0]);
		    }
		};
		
		function uploadFile(){
			var form = $('#post-form')[0];
			var formData = new FormData(form);

			var it = formData.values();
			while(true){
				var item = it.next();
				
				if(!item.value) break;
				console.log(item);
			}
			
			$.ajax({
				url : '/post/upload',
				type : 'POST',
				processData : false,
				contentType : false,
           		data: formData,
           		success : function(result){
           			console.log(result);
           		},
           		error : function(error){
           			console.log(error);
           		}
			});
			
		};
	</script>
</body>
</html>